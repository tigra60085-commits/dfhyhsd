"""Drug interaction database."""

# List of interaction dicts. Each entry has:
# "drugs": list of 2 drug names (case-insensitive matching)
# "severity": "severe" | "moderate" | "mild"
# "description": explanation of interaction and mechanism

INTERACTIONS = [
    {
        "drugs": ["MAOI", "SSRI"],
        "severity": "severe",
        "description": (
            "Серотониновый синдром — потенциально смертельно. "
            "Механизм: оба класса повышают серотонинергическую передачу разными путями. "
            "Требуется период отмывания: 14 дней после отмены MAOI перед началом SSRI; "
            "14 дней после отмены большинства SSRI перед MAOI; "
            "5 НЕДЕЛЬ после флуоксетина (длинный T½ + активный метаболит)."
        ),
    },
    {
        "drugs": ["MAOI", "трамадол"],
        "severity": "severe",
        "description": (
            "Серотониновый синдром + риск судорог. "
            "Трамадол ингибирует захват серотонина и норэпинефрина. "
            "Комбинация абсолютно противопоказана."
        ),
    },
    {
        "drugs": ["MAOI", "меперидин"],
        "severity": "severe",
        "description": (
            "Тяжёлый серотониновый синдром со смертельным исходом. "
            "Меперидин — единственный опиоид с выраженным серотонинергическим действием. "
            "Абсолютно противопоказан при приёме любых MAOI."
        ),
    },
    {
        "drugs": ["MAOI", "симпатомиметики"],
        "severity": "severe",
        "description": (
            "Гипертонический криз. "
            "MAO-A метаболизирует норэпинефрин. При ингибировании MAO симпатомиметики "
            "(псевдоэфедрин, фенилэфрин в каплях от насморка) вызывают массивный выброс NE."
        ),
    },
    {
        "drugs": ["литий", "НПВС"],
        "severity": "moderate",
        "description": (
            "НПВС повышают уровень лития на 20–60% через ингибирование простагландинов "
            "→ снижение почечного клиренса лития. Риск токсичности лития. "
            "Парацетамол — предпочтительный анальгетик при терапии литием."
        ),
    },
    {
        "drugs": ["литий", "тиазиды"],
        "severity": "moderate",
        "description": (
            "Тиазидные диуретики вызывают потерю натрия → почка компенсаторно усиливает "
            "реабсорбцию Na+ (и лития!) → повышение уровня лития → токсичность. "
            "Необходимо снижение дозы лития и мониторинг уровня."
        ),
    },
    {
        "drugs": ["литий", "АПФ-ингибиторы"],
        "severity": "moderate",
        "description": (
            "АПФ-ингибиторы снижают почечный клиренс лития (~40%). "
            "При назначении или отмене иАПФ необходим контроль уровня лития."
        ),
    },
    {
        "drugs": ["вальпроат", "ламотриджин"],
        "severity": "moderate",
        "description": (
            "Вальпроат ингибирует UGT1A4 — основной фермент глюкуронидирования ламотриджина. "
            "Уровень ламотриджина повышается в ~2 раза. "
            "При совместном применении ОБЯЗАТЕЛЬНО снижать дозу ламотриджина вдвое "
            "и применять более медленный протокол титрации (снижает риск синдрома Стивенса–Джонсона)."
        ),
    },
    {
        "drugs": ["вальпроат", "карбамазепин"],
        "severity": "moderate",
        "description": (
            "Карбамазепин — индуктор CYP3A4 и UGT → снижает уровень вальпроата. "
            "Вальпроат повышает уровень активного метаболита карбамазепина (карбамазепин-10,11-эпоксид) → "
            "нейротоксичность (двоение, атаксия). Требуется тщательный мониторинг."
        ),
    },
    {
        "drugs": ["пароксетин", "тамоксифен"],
        "severity": "severe",
        "description": (
            "Пароксетин — мощный ингибитор CYP2D6. Тамоксифен конвертируется CYP2D6 "
            "в активный метаболит эндоксифен. При совместном применении уровень эндоксифена "
            "снижается на 65–75% → значительное снижение противоопухолевой эффективности. "
            "При депрессии на фоне тамоксифена предпочтительны: сертралин, циталопрам, эсциталопрам."
        ),
    },
    {
        "drugs": ["флуоксетин", "тамоксифен"],
        "severity": "moderate",
        "description": (
            "Флуоксетин — умеренно-сильный ингибитор CYP2D6. "
            "Снижает уровень эндоксифена значительно, хотя и меньше, чем пароксетин. "
            "Лучше избегать комбинации."
        ),
    },
    {
        "drugs": ["клозапин", "бензодиазепины"],
        "severity": "moderate",
        "description": (
            "Риск тяжёлой гипотензии, угнетения дыхания и сердечно-лёгочной остановки "
            "при в/м введении бензодиазепина пациентам на клозапине. "
            "При необходимости разделять приём на несколько часов. "
            "Пероральное совместное применение под наблюдением допустимо с осторожностью."
        ),
    },
    {
        "drugs": ["клозапин", "флувоксамин"],
        "severity": "moderate",
        "description": (
            "Флувоксамин — мощный ингибитор CYP1A2, основного фермента метаболизма клозапина. "
            "Уровень клозапина может возрасти в 5–10 раз → токсичность (судороги, кардиотоксичность). "
            "Комбинация требует значительного снижения дозы клозапина или смены антидепрессанта."
        ),
    },
    {
        "drugs": ["карбамазепин", "оральные контрацептивы"],
        "severity": "moderate",
        "description": (
            "Карбамазепин — сильный индуктор CYP3A4, основного фермента метаболизма эстрогенов и прогестинов. "
            "Значительное снижение эффективности гормональных контрацептивов → нежелательная беременность. "
            "Необходима дополнительная контрацепция (барьерные методы)."
        ),
    },
    {
        "drugs": ["ламотриджин", "оральные контрацептивы"],
        "severity": "moderate",
        "description": (
            "Эстрогены индуцируют UGT → снижают уровень ламотриджина на ~50%. "
            "Когда женщина начинает или отменяет КОК, уровень ламотриджина резко меняется — "
            "риск рецидива или токсичности. Необходим мониторинг и коррекция дозы."
        ),
    },
    {
        "drugs": ["опиоиды", "бензодиазепины"],
        "severity": "severe",
        "description": (
            "Синергичное угнетение ЦНС → остановка дыхания. "
            "Комбинация несёт предупреждение 'чёрная рамка' FDA (black box warning). "
            "Если необходимо совместное применение — минимальные дозы, мониторинг, налоксон доступен."
        ),
    },
    {
        "drugs": ["трициклические антидепрессанты", "MAOIs"],
        "severity": "severe",
        "description": (
            "Серотониновый синдром + гипертонический криз. "
            "ТЦА ингибируют захват NE и 5-HT. Комбинация с MAOI абсолютно противопоказана. "
            "Период отмывания: 14 дней после MAOI и перед назначением ТЦА."
        ),
    },
    {
        "drugs": ["варфарин", "флуоксетин"],
        "severity": "moderate",
        "description": (
            "Флуоксетин ингибирует CYP2C9 — основной фермент метаболизма S-варфарина (активная форма). "
            "Уровень варфарина повышается → риск кровотечений. "
            "Необходим мониторинг МНО, особенно в начале и при изменении дозы флуоксетина."
        ),
    },
    {
        "drugs": ["золпидем", "алкоголь"],
        "severity": "severe",
        "description": (
            "Синергичное угнетение ЦНС. Риск амнезии, сомнамбулизма, угнетения дыхания. "
            "Алкоголь повышает пиковую концентрацию золпидема. Комбинация противопоказана."
        ),
    },
    {
        "drugs": ["литий", "нейролептики"],
        "severity": "mild",
        "description": (
            "Литий может маскировать ранние признаки токсичности нейролептиков. "
            "Описаны единичные случаи необратимой нейротоксичности при высоких дозах обоих. "
            "Мониторинг уровня лития и клинического состояния."
        ),
    },
    # ── Дополнительные взаимодействия ──────────────────────────────────────────
    {
        "drugs": ["SSRI", "трамадол"],
        "severity": "moderate",
        "description": (
            "Трамадол ингибирует обратный захват серотонина и норэпинефрина → риск серотонинового синдрома "
            "при совместном применении с SSRI/SNRI. Кроме того, SSRI (особенно флуоксетин и пароксетин) "
            "ингибируют CYP2D6, снижая конверсию трамадола в активный метаболит (O-десметилтрамадол) → "
            "снижение анальгетического эффекта, но при этом накопление серотонинергических эффектов самого трамадола."
        ),
    },
    {
        "drugs": ["SSRI", "НПВС"],
        "severity": "moderate",
        "description": (
            "SSRI подавляют агрегацию тромбоцитов (тромбоциты зависят от серотонина для агрегации). "
            "Комбинация с НПВС (которые блокируют ЦОГ и синтез ТхА2) увеличивает риск желудочно-кишечных "
            "кровотечений в 3–15 раз. Рекомендуется гастропротекция (ИПП) при длительном совместном применении."
        ),
    },
    {
        "drugs": ["литий", "карбамазепин"],
        "severity": "moderate",
        "description": (
            "Комбинация литий + карбамазепин может вызывать нейротоксичность даже при нормальных уровнях "
            "обоих препаратов в крови: атаксия, спутанность, судороги. Требуется тщательный клинический "
            "мониторинг, хотя иногда комбинацию используют при рефрактерных биполярных расстройствах."
        ),
    },
    {
        "drugs": ["карбамазепин", "ламотриджин"],
        "severity": "moderate",
        "description": (
            "Карбамазепин — мощный индуктор UGT1A4 → ускоряет глюкуронидирование ламотриджина → "
            "снижение уровня ламотриджина на 40–50%. При добавлении карбамазепина необходимо увеличение "
            "дозы ламотриджина; при его отмене — снижение дозы ламотриджина (риск токсичности)."
        ),
    },
    {
        "drugs": ["антипсихотики", "метоклопрамид"],
        "severity": "moderate",
        "description": (
            "Оба препарата блокируют D2-рецепторы → аддитивный риск экстрапирамидных расстройств "
            "(акатизия, дистония, поздняя дискинезия). Метоклопрамид по возможности следует заменить "
            "на домперидон или ондансетрон у пациентов на антипсихотиках."
        ),
    },
    {
        "drugs": ["антипсихотики", "препараты, удлиняющие QT"],
        "severity": "severe",
        "description": (
            "Большинство антипсихотиков (особенно галоперидол, зипразидон, тиоридазин) удлиняют интервал QTc. "
            "Комбинация с другими препаратами, удлиняющими QT (антиаритмики класса I/III, макролиды, хинолоны, "
            "метадон, цизаприд) → риск полиморфной желудочковой тахикардии типа 'torsade de pointes' "
            "(TdP) → фибрилляция желудочков и внезапная смерть. Необходим мониторинг ЭКГ."
        ),
    },
    {
        "drugs": ["клозапин", "курение"],
        "severity": "moderate",
        "description": (
            "Полициклические ароматические углеводороды сигаретного дыма являются мощными индукторами CYP1A2 "
            "— основного пути метаболизма клозапина. Уровень клозапина у курящих на 30–50% ниже, чем "
            "у некурящих. При резком отказе от курения (госпитализация) уровень клозапина резко возрастает → "
            "риск токсичности (судороги, кардиотоксичность). Мониторинг и коррекция дозы обязательны."
        ),
    },
    {
        "drugs": ["вальпроат", "аспирин"],
        "severity": "moderate",
        "description": (
            "Аспирин вытесняет вальпроат из связи с белками плазмы → временное увеличение свободной фракции "
            "вальпроата → усиление эффектов и побочных реакций. Кроме того, вальпроат ингибирует агрегацию "
            "тромбоцитов; аспирин действует синергично → риск кровотечений."
        ),
    },
    {
        "drugs": ["MAOI", "тирамин"],
        "severity": "severe",
        "description": (
            "Тираминовая реакция ('сырный эффект'): тирамин в норме разрушается MAO в кишечнике/печени. "
            "При ингибировании MAO тирамин попадает в системный кровоток → высвобождение норэпинефрина "
            "из окончаний симпатических нейронов → острый гипертонический криз (АД >180/120 мм рт.ст.), "
            "головная боль, носовое кровотечение, риск инсульта. Продукты с высоким содержанием тирамина: "
            "выдержанные сыры, копчёности, красное вино, пиво, соевый соус, квашеная капуста."
        ),
    },
    {
        "drugs": ["бупропион", "трамадол"],
        "severity": "moderate",
        "description": (
            "Бупропион является мощным ингибитором CYP2D6, ответственного за конверсию трамадола в O-десметилтрамадол. "
            "Снижение анальгетического эффекта + накопление серотонинергического потенциала трамадола → "
            "риск серотонинового синдрома. Кроме того, оба препарата снижают судорожный порог."
        ),
    },
    {
        "drugs": ["метилфенидат", "MAOI"],
        "severity": "severe",
        "description": (
            "Гипертонический криз + возможный серотониновый синдром. "
            "Метилфенидат блокирует обратный захват DA и NE; MAO ингибирует их деградацию → "
            "массивное накопление катехоламинов. Комбинация абсолютно противопоказана. "
            "Период отмывания: 14 дней после отмены MAO перед назначением метилфенидата."
        ),
    },
    {
        "drugs": ["буспирон", "MAOI"],
        "severity": "severe",
        "description": (
            "Потенциальный серотониновый синдром и гипертонический криз. "
            "Буспирон — частичный агонист 5-HT1A; MAO ингибируют деградацию серотонина. "
            "Комбинация противопоказана; период отмывания 14 дней после отмены MAOI."
        ),
    },
    {
        "drugs": ["SNRI", "линезолид"],
        "severity": "severe",
        "description": (
            "Линезолид — антибиотик класса оксазолидинонов, обладающий слабой MAO-ингибирующей активностью. "
            "Комбинация с SSRI/SNRI → серотониновый синдром. Описаны тяжёлые случаи при плановых курсах "
            "антибиотикотерапии. При необходимости линезолида — временная отмена серотонинергических препаратов "
            "или их замена (мониторинг 24 часа)."
        ),
    },
    {
        "drugs": ["антипсихотики", "антихолинергические препараты"],
        "severity": "moderate",
        "description": (
            "Антихолинергические препараты (тригексифенидил, бипериден) часто назначают для коррекции ЭПС "
            "от антипсихотиков. Однако аддитивный холинолитический эффект → делирий у пожилых, "
            "когнитивные нарушения, острая задержка мочи, запор, тахикардия. "
            "Лучше снизить дозу антипсихотика или перейти на препарат с меньшими ЭПС."
        ),
    },
    {
        "drugs": ["атомоксетин", "CYP2D6 ингибиторы"],
        "severity": "moderate",
        "description": (
            "Атомоксетин метаболизируется преимущественно через CYP2D6. Сильные ингибиторы CYP2D6 "
            "(пароксетин, флуоксетин, бупропион) повышают уровень атомоксетина в 6–8 раз у быстрых "
            "метаболизаторов → усиление побочных эффектов (тахикардия, гипертензия, задержка мочи, "
            "суицидальные мысли). Требуется снижение дозы атомоксетина."
        ),
    },
    {
        "drugs": ["оланзапин", "флувоксамин"],
        "severity": "moderate",
        "description": (
            "Флувоксамин — мощный ингибитор CYP1A2, основного фермента метаболизма оланзапина. "
            "Уровень оланзапина может повышаться в 2–3 раза → усиление седации, прибавки в весе, "
            "риск метаболических нарушений. При необходимости комбинации — снижение дозы оланзапина."
        ),
    },
    {
        "drugs": ["ламотриджин", "сертралин"],
        "severity": "mild",
        "description": (
            "Сертралин умеренно ингибирует глюкуронидирование ламотриджина → возможное повышение уровня "
            "ламотриджина (~25%). Клинически значимо при пограничных уровнях. Рекомендуется мониторинг "
            "симптомов (головокружение, диплопия, тошнота) и при необходимости коррекция дозы ламотриджина."
        ),
    },
    {
        "drugs": ["литий", "кофеин"],
        "severity": "mild",
        "description": (
            "Высокое потребление кофеина увеличивает почечную экскрецию лития (конкурентный ингибитор "
            "реабсорбции). Резкая отмена кофеина (например, при госпитализации) → снижение экскреции → "
            "рост уровня лития → токсичность. Рекомендуется поддерживать стабильное потребление кофеина."
        ),
    },
    {
        "drugs": ["антидепрессанты", "суматриптан"],
        "severity": "mild",
        "description": (
            "Суматриптан — агонист 5-HT1B/1D-рецепторов. Теоретический риск серотонинового синдрома при "
            "комбинации с SSRI/SNRI. По данным FDA, клинически значимые случаи редки, однако пациенты "
            "должны быть информированы о симптомах серотонинового синдрома. Большинство руководств "
            "считают комбинацию допустимой при стандартных дозах."
        ),
    },
    {
        "drugs": ["антипсихотики", "алкоголь"],
        "severity": "moderate",
        "description": (
            "Синергичное угнетение ЦНС → выраженная седация, нарушение координации. "
            "Алкоголь усугубляет экстрапирамидные расстройства и ортостатическую гипотензию. "
            "Антипсихотики с выраженной α1-блокадой (клозапин, хлорпромазин) особенно опасны — "
            "риск синкопе и падений. Пациентам следует воздерживаться от алкоголя."
        ),
    },
    {
        "drugs": ["бензодиазепины", "алкоголь"],
        "severity": "severe",
        "description": (
            "Глубокое синергичное угнетение ЦНС через ГАМК-А рецепторы → угнетение дыхания, кома, смерть. "
            "Относительный риск летального исхода при передозировке возрастает в 7–8 раз по сравнению с "
            "бензодиазепинами без алкоголя. Это одна из наиболее частых причин смерти от лекарственного "
            "взаимодействия. Категорически противопоказано."
        ),
    },
    {
        "drugs": ["прегабалин", "опиоиды"],
        "severity": "severe",
        "description": (
            "Прегабалин и габапентин потенцируют угнетение дыхания опиоидами синергично. "
            "Риск опиоид-индуцированной апноэ возрастает; описаны смертельные случаи. "
            "FDA выдало предупреждение в 2019 г. При необходимости комбинации — мониторинг "
            "дыхательной функции, минимальные дозы обоих препаратов."
        ),
    },
    {
        "drugs": ["донепезил", "холинолитики"],
        "severity": "moderate",
        "description": (
            "Фармакодинамический антагонизм: ингибиторы ХЭ (донепезил, ривастигмин, галантамин) "
            "повышают содержание АЦХ; холинолитики (тригексифенидил, оксибутинин, дифенгидрамин, "
            "многие ТЦА) блокируют м-холинорецепторы. Результат — взаимная нейтрализация эффектов. "
            "Применение холинолитических препаратов при деменции Альцгеймера следует избегать."
        ),
    },
    {
        "drugs": ["вальпроат", "фенитоин"],
        "severity": "moderate",
        "description": (
            "Двунаправленное взаимодействие: вальпроат вытесняет фенитоин из связи с белками плазмы "
            "→ транзиторное повышение свободной (активной) фракции фенитоина при нормальном общем уровне "
            "(ложно-низкий общий фенитоин). Одновременно вальпроат ингибирует метаболизм фенитоина. "
            "Мониторинг свободного фенитоина обязателен."
        ),
    },
    {
        "drugs": ["арипипразол", "CYP2D6 ингибиторы"],
        "severity": "moderate",
        "description": (
            "Арипипразол метаболизируется через CYP2D6 и CYP3A4. Сильные ингибиторы CYP2D6 "
            "(пароксетин, флуоксетин, бупропион) могут повышать уровень арипипразола в 2–3 раза → "
            "усиление акатизии и других побочных эффектов. Рекомендуется снижение дозы арипипразола на 50%."
        ),
    },
    {
        "drugs": ["арипипразол", "карбамазепин"],
        "severity": "moderate",
        "description": (
            "Карбамазепин — мощный индуктор CYP3A4, основного пути метаболизма арипипразола. "
            "Уровень арипипразола снижается в ~2 раза → снижение эффективности. "
            "При совместном применении рекомендуется удваивать дозу арипипразола. "
            "Аналогичный эффект у рифампицина и других CYP3A4-индукторов."
        ),
    },
    {
        "drugs": ["луразидон", "ингибиторы CYP3A4"],
        "severity": "severe",
        "description": (
            "Луразидон полностью метаболизируется через CYP3A4. Сильные ингибиторы CYP3A4 "
            "(кетоконазол, кларитромицин, ритонавир) повышают уровень луразидона более чем в 9 раз → "
            "серьёзная токсичность (глубокая седация, гипотензия, ЭПС). Комбинация противопоказана. "
            "Грейпфрутовый сок — умеренный ингибитор CYP3A4; следует избегать."
        ),
    },
    {
        "drugs": ["SNRI", "трамадол"],
        "severity": "moderate",
        "description": (
            "SNRI (венлафаксин, дулоксетин) и трамадол оба ингибируют обратный захват серотонина "
            "и норэпинефрина, а трамадол дополнительно является агонистом μ-опиоидных рецепторов. "
            "Комбинация значительно повышает риск серотонинового синдрома и судорог. "
            "Рекомендуется избегать или использовать под строгим контролем."
        ),
    },
    {
        "drugs": ["флуоксетин", "пимозид"],
        "severity": "severe",
        "description": (
            "Флуоксетин мощно ингибирует CYP2D6 и CYP3A4, через которые метаболизируется пимозид. "
            "Значительное повышение уровня пимозида → критическое удлинение QTc → "
            "риск TdP и внезапной сердечной смерти. Комбинация абсолютно противопоказана."
        ),
    },
]


def find_interaction(drug1: str, drug2: str) -> list:
    """Find all interactions involving both drug names (case-insensitive partial match)."""
    d1 = drug1.lower()
    d2 = drug2.lower()
    results = []
    for interaction in INTERACTIONS:
        drugs_lower = [d.lower() for d in interaction["drugs"]]
        match1 = any(d1 in d or d in d1 for d in drugs_lower)
        match2 = any(d2 in d or d in d2 for d in drugs_lower)
        if match1 and match2:
            results.append(interaction)
    return results


def find_interactions_for_drug(drug_name: str) -> list:
    """Find all interactions involving a specific drug."""
    d = drug_name.lower()
    results = []
    for interaction in INTERACTIONS:
        drugs_lower = [dr.lower() for dr in interaction["drugs"]]
        if any(d in dr or dr in d for dr in drugs_lower):
            results.append(interaction)
    return results
