"""Drug interaction database."""

# List of interaction dicts. Each entry has:
# "drugs": list of 2 drug names (case-insensitive matching)
# "severity": "severe" | "moderate" | "mild"
# "description": explanation of interaction and mechanism

INTERACTIONS = [
    {
        "drugs": ["MAOI", "SSRI"],
        "severity": "severe",
        "description": (
            "Серотониновый синдром — потенциально смертельно. "
            "Механизм: оба класса повышают серотонинергическую передачу разными путями. "
            "Требуется период отмывания: 14 дней после отмены MAOI перед началом SSRI; "
            "14 дней после отмены большинства SSRI перед MAOI; "
            "5 НЕДЕЛЬ после флуоксетина (длинный T½ + активный метаболит)."
        ),
    },
    {
        "drugs": ["MAOI", "трамадол"],
        "severity": "severe",
        "description": (
            "Серотониновый синдром + риск судорог. "
            "Трамадол ингибирует захват серотонина и норэпинефрина. "
            "Комбинация абсолютно противопоказана."
        ),
    },
    {
        "drugs": ["MAOI", "меперидин"],
        "severity": "severe",
        "description": (
            "Тяжёлый серотониновый синдром со смертельным исходом. "
            "Меперидин — единственный опиоид с выраженным серотонинергическим действием. "
            "Абсолютно противопоказан при приёме любых MAOI."
        ),
    },
    {
        "drugs": ["MAOI", "симпатомиметики"],
        "severity": "severe",
        "description": (
            "Гипертонический криз. "
            "MAO-A метаболизирует норэпинефрин. При ингибировании MAO симпатомиметики "
            "(псевдоэфедрин, фенилэфрин в каплях от насморка) вызывают массивный выброс NE."
        ),
    },
    {
        "drugs": ["литий", "НПВС"],
        "severity": "moderate",
        "description": (
            "НПВС повышают уровень лития на 20–60% через ингибирование простагландинов "
            "→ снижение почечного клиренса лития. Риск токсичности лития. "
            "Парацетамол — предпочтительный анальгетик при терапии литием."
        ),
    },
    {
        "drugs": ["литий", "тиазиды"],
        "severity": "moderate",
        "description": (
            "Тиазидные диуретики вызывают потерю натрия → почка компенсаторно усиливает "
            "реабсорбцию Na+ (и лития!) → повышение уровня лития → токсичность. "
            "Необходимо снижение дозы лития и мониторинг уровня."
        ),
    },
    {
        "drugs": ["литий", "АПФ-ингибиторы"],
        "severity": "moderate",
        "description": (
            "АПФ-ингибиторы снижают почечный клиренс лития (~40%). "
            "При назначении или отмене иАПФ необходим контроль уровня лития."
        ),
    },
    {
        "drugs": ["вальпроат", "ламотриджин"],
        "severity": "moderate",
        "description": (
            "Вальпроат ингибирует UGT1A4 — основной фермент глюкуронидирования ламотриджина. "
            "Уровень ламотриджина повышается в ~2 раза. "
            "При совместном применении ОБЯЗАТЕЛЬНО снижать дозу ламотриджина вдвое "
            "и применять более медленный протокол титрации (снижает риск синдрома Стивенса–Джонсона)."
        ),
    },
    {
        "drugs": ["вальпроат", "карбамазепин"],
        "severity": "moderate",
        "description": (
            "Карбамазепин — индуктор CYP3A4 и UGT → снижает уровень вальпроата. "
            "Вальпроат повышает уровень активного метаболита карбамазепина (карбамазепин-10,11-эпоксид) → "
            "нейротоксичность (двоение, атаксия). Требуется тщательный мониторинг."
        ),
    },
    {
        "drugs": ["пароксетин", "тамоксифен"],
        "severity": "severe",
        "description": (
            "Пароксетин — мощный ингибитор CYP2D6. Тамоксифен конвертируется CYP2D6 "
            "в активный метаболит эндоксифен. При совместном применении уровень эндоксифена "
            "снижается на 65–75% → значительное снижение противоопухолевой эффективности. "
            "При депрессии на фоне тамоксифена предпочтительны: сертралин, циталопрам, эсциталопрам."
        ),
    },
    {
        "drugs": ["флуоксетин", "тамоксифен"],
        "severity": "moderate",
        "description": (
            "Флуоксетин — умеренно-сильный ингибитор CYP2D6. "
            "Снижает уровень эндоксифена значительно, хотя и меньше, чем пароксетин. "
            "Лучше избегать комбинации."
        ),
    },
    {
        "drugs": ["клозапин", "бензодиазепины"],
        "severity": "moderate",
        "description": (
            "Риск тяжёлой гипотензии, угнетения дыхания и сердечно-лёгочной остановки "
            "при в/м введении бензодиазепина пациентам на клозапине. "
            "При необходимости разделять приём на несколько часов. "
            "Пероральное совместное применение под наблюдением допустимо с осторожностью."
        ),
    },
    {
        "drugs": ["клозапин", "флувоксамин"],
        "severity": "moderate",
        "description": (
            "Флувоксамин — мощный ингибитор CYP1A2, основного фермента метаболизма клозапина. "
            "Уровень клозапина может возрасти в 5–10 раз → токсичность (судороги, кардиотоксичность). "
            "Комбинация требует значительного снижения дозы клозапина или смены антидепрессанта."
        ),
    },
    {
        "drugs": ["карбамазепин", "оральные контрацептивы"],
        "severity": "moderate",
        "description": (
            "Карбамазепин — сильный индуктор CYP3A4, основного фермента метаболизма эстрогенов и прогестинов. "
            "Значительное снижение эффективности гормональных контрацептивов → нежелательная беременность. "
            "Необходима дополнительная контрацепция (барьерные методы)."
        ),
    },
    {
        "drugs": ["ламотриджин", "оральные контрацептивы"],
        "severity": "moderate",
        "description": (
            "Эстрогены индуцируют UGT → снижают уровень ламотриджина на ~50%. "
            "Когда женщина начинает или отменяет КОК, уровень ламотриджина резко меняется — "
            "риск рецидива или токсичности. Необходим мониторинг и коррекция дозы."
        ),
    },
    {
        "drugs": ["опиоиды", "бензодиазепины"],
        "severity": "severe",
        "description": (
            "Синергичное угнетение ЦНС → остановка дыхания. "
            "Комбинация несёт предупреждение 'чёрная рамка' FDA (black box warning). "
            "Если необходимо совместное применение — минимальные дозы, мониторинг, налоксон доступен."
        ),
    },
    {
        "drugs": ["трициклические антидепрессанты", "MAOIs"],
        "severity": "severe",
        "description": (
            "Серотониновый синдром + гипертонический криз. "
            "ТЦА ингибируют захват NE и 5-HT. Комбинация с MAOI абсолютно противопоказана. "
            "Период отмывания: 14 дней после MAOI и перед назначением ТЦА."
        ),
    },
    {
        "drugs": ["варфарин", "флуоксетин"],
        "severity": "moderate",
        "description": (
            "Флуоксетин ингибирует CYP2C9 — основной фермент метаболизма S-варфарина (активная форма). "
            "Уровень варфарина повышается → риск кровотечений. "
            "Необходим мониторинг МНО, особенно в начале и при изменении дозы флуоксетина."
        ),
    },
    {
        "drugs": ["золпидем", "алкоголь"],
        "severity": "severe",
        "description": (
            "Синергичное угнетение ЦНС. Риск амнезии, сомнамбулизма, угнетения дыхания. "
            "Алкоголь повышает пиковую концентрацию золпидема. Комбинация противопоказана."
        ),
    },
    {
        "drugs": ["литий", "нейролептики"],
        "severity": "mild",
        "description": (
            "Литий может маскировать ранние признаки токсичности нейролептиков. "
            "Описаны единичные случаи необратимой нейротоксичности при высоких дозах обоих. "
            "Мониторинг уровня лития и клинического состояния."
        ),
    },
]


def find_interaction(drug1: str, drug2: str) -> list:
    """Find all interactions involving both drug names (case-insensitive partial match)."""
    d1 = drug1.lower()
    d2 = drug2.lower()
    results = []
    for interaction in INTERACTIONS:
        drugs_lower = [d.lower() for d in interaction["drugs"]]
        match1 = any(d1 in d or d in d1 for d in drugs_lower)
        match2 = any(d2 in d or d in d2 for d in drugs_lower)
        if match1 and match2:
            results.append(interaction)
    return results


def find_interactions_for_drug(drug_name: str) -> list:
    """Find all interactions involving a specific drug."""
    d = drug_name.lower()
    results = []
    for interaction in INTERACTIONS:
        drugs_lower = [dr.lower() for dr in interaction["drugs"]]
        if any(d in dr or dr in d for dr in drugs_lower):
            results.append(interaction)
    return results
