"""Podcast-dialog: educational podcast episode script generator.

Implements the podcast-dialog skill:
  ‚Ä¢ Multi-step conversation: topic ‚Üí optional clinical case ‚Üí duration
  ‚Ä¢ Generates a structured 7-block podcast script (Telegram preview)
  ‚Ä¢ Generates formatted .docx episode script with numbered lines
  ‚Ä¢ Generates a Telegram announcement post
"""

import io
import random
from datetime import date

from telegram import Update, InputFile
from telegram.ext import ContextTypes

from states import PODCAST_TOPIC, PODCAST_CASE, PODCAST_DURATION, MAIN_MENU
from keyboards.menus import (
    podcast_duration_keyboard, podcast_result_keyboard,
    main_menu_keyboard, back_keyboard,
)
from data.drugs import get_drug_by_name, search_drugs, DRUGS
from data.neurotransmitters import NEUROTRANSMITTERS
from data.glossary import GLOSSARY
from data.tips import TIPS

# ‚îÄ‚îÄ‚îÄ Conversation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def start_podcast(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "üéôÔ∏è *–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–¥–∫–∞—Å—Ç-—ç–ø–∏–∑–æ–¥–∞*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ *—Ç–µ–º—É* —ç–ø–∏–∑–æ–¥–∞ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞, –≥—Ä—É–ø–ø—ã –∏–ª–∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã:\n"
        "_–ü—Ä–∏–º–µ—Ä—ã: ¬´–§–ª—É–æ–∫—Å–µ—Ç–∏–Ω¬ª, ¬´SSRI¬ª, ¬´–°–µ—Ä–æ—Ç–æ–Ω–∏–Ω–æ–≤—ã–π —Å–∏–Ω–¥—Ä–æ–º¬ª, ¬´–ê–Ω—Ç–∏–ø—Å–∏—Ö–æ—Ç–∏–∫–∏ –ø—Ä–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏¬ª_",
        parse_mode="Markdown",
        reply_markup=back_keyboard("back:main"),
    )
    return PODCAST_TOPIC


async def podcast_topic_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É —ç–ø–∏–∑–æ–¥–∞.")
        return PODCAST_TOPIC

    context.user_data["pd_topic"] = text
    await update.message.reply_text(
        f"–¢–µ–º–∞: *{text}*\n\n"
        "–û–ø–∏—à–∏—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π —Å–ª—É—á–∞–π-¬´–∫—Ä—é—á–æ–∫¬ª –¥–ª—è –Ω–∞—á–∞–ª–∞ —ç–ø–∏–∑–æ–¥–∞:\n"
        "_–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ_ /skip _—á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å_",
        parse_mode="Markdown",
        reply_markup=back_keyboard("back:main"),
    )
    return PODCAST_CASE


async def podcast_case_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    text = update.message.text.strip()
    context.user_data["pd_case"] = "" if text.lower() in ("/skip", "skip") else text
    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç–ø–∏–∑–æ–¥–∞:",
        reply_markup=podcast_duration_keyboard(),
    )
    return PODCAST_DURATION


async def podcast_duration_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "back:main":
        await query.message.reply_text("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu_keyboard())
        await query.message.delete()
        return MAIN_MENU

    if data == "pd:again":
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –Ω–æ–≤–æ–≥–æ —ç–ø–∏–∑–æ–¥–∞:")
        return PODCAST_TOPIC

    if not data.startswith("pdur:"):
        return PODCAST_DURATION

    context.user_data["pd_duration"] = data[len("pdur:"):]
    topic = context.user_data.get("pd_topic", "")
    case = context.user_data.get("pd_case", "")
    duration = context.user_data.get("pd_duration", "medium")

    await query.edit_message_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ü–µ–Ω–∞—Ä–∏–π —ç–ø–∏–∑–æ–¥–∞...")

    # Resolve drug data for topic
    drug_data = _resolve_topic(topic)

    # Build episode content
    episode = _build_episode(topic, drug_data, case, duration)

    # Send Telegram preview (blocks 0 + 1 + key points)
    preview = _build_telegram_preview(episode)
    for i in range(0, len(preview), 4000):
        await query.message.reply_text(preview[i:i + 4000], parse_mode="Markdown")

    # Send Telegram announcement
    announce = _build_telegram_announce(episode, topic)
    await query.message.reply_text(announce, parse_mode="Markdown")

    # Generate and send docx
    try:
        docx_buf = _build_docx(episode, topic, duration)
        slug = topic[:20].replace(" ", "_").replace("/", "-")
        filename = f"podcast_ep_{slug}_v1.docx"
        await query.message.reply_document(
            document=InputFile(docx_buf, filename=filename),
            caption="üìÑ –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —ç–ø–∏–∑–æ–¥–∞ (.docx)",
        )
    except ImportError:
        await query.message.reply_text(
            "‚ö†Ô∏è python-docx –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: `pip install python-docx`",
            parse_mode="Markdown",
        )
    except Exception as exc:
        await query.message.reply_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ .docx: {exc}")

    await query.message.reply_text(
        "–≠–ø–∏–∑–æ–¥ –≥–æ—Ç–æ–≤.",
        reply_markup=podcast_result_keyboard(),
    )
    return PODCAST_DURATION


# ‚îÄ‚îÄ‚îÄ Topic resolution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _resolve_topic(topic: str) -> dict | None:
    d = get_drug_by_name(topic)
    if not d:
        results = search_drugs(topic)
        d = results[0] if results else None
    return d


# ‚îÄ‚îÄ‚îÄ Episode content builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

_DURATION_CONFIG = {"short": 4, "medium": 7, "long": 10}  # approx dialogue exchanges per block

def _build_episode(topic: str, drug: dict | None, case: str, duration: str) -> dict:
    """Build the full episode content structure."""
    density = _DURATION_CONFIG.get(duration, 7)
    dur_label = {"short": "~15 –º–∏–Ω", "medium": "~30 –º–∏–Ω", "long": "~45 –º–∏–Ω"}.get(duration, "~30 –º–∏–Ω")

    # Build clinical hook
    hook_case = case if case else _auto_case(topic, drug)
    hook_expert_note = _hook_expert_note(topic, drug)

    # Theory block
    theory = _build_theory(topic, drug, density)

    # Clinical decisions
    clinical = _build_clinical(topic, drug, density)

    # NR and interactions
    nr_block = _build_nr_block(topic, drug)

    # Errors
    errors = _build_errors(topic, drug)

    # Pearls
    pearls = _build_pearls(topic, drug)

    # Summary
    key_points = _build_key_points(topic, drug)

    return {
        "topic": topic,
        "drug": drug,
        "duration": dur_label,
        "hook_case": hook_case,
        "hook_expert_note": hook_expert_note,
        "theory": theory,
        "clinical": clinical,
        "nr_block": nr_block,
        "errors": errors,
        "pearls": pearls,
        "key_points": key_points,
        "date": date.today().strftime("%d.%m.%Y"),
    }


def _auto_case(topic: str, drug: dict | None) -> str:
    if drug:
        ind = (drug.get("indications") or ["—Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è"])[0]
        se = (drug.get("side_effects") or ["–ø–æ–±–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç"])[0]
        return (
            f"–ö–æ –º–Ω–µ –Ω–∞ –ø—Ä–∏—ë–º –ø—Ä–∏—à—ë–ª –ø–∞—Ü–∏–µ–Ω—Ç 35 –ª–µ—Ç —Å –¥–∏–∞–≥–Ω–æ–∑–æ–º ¬´{ind}¬ª. "
            f"–ú—ã –Ω–∞–∑–Ω–∞—á–∏–ª–∏ {drug['name']}, –∏ —á–µ—Ä–µ–∑ 3 –Ω–µ–¥–µ–ª–∏ –æ–Ω –ø–æ–∑–≤–æ–Ω–∏–ª –∏ –∂–∞–ª–æ–≤–∞–ª—Å—è –Ω–∞ {se.lower()}. "
            f"–Ø –Ω–µ –∑–Ω–∞–ª, –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–∏–º–ø—Ç–æ–º ‚Äî —ç—Ç–æ –ø–æ–±–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç, "
            f"—Ä–µ—Ü–∏–¥–∏–≤, –∏–ª–∏ —á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ —Å–µ—Ä—å—ë–∑–Ω–æ–µ?"
        )
    return (
        f"–ö–æ –º–Ω–µ –æ–±—Ä–∞—Ç–∏–ª–∞—Å—å –ø–∞—Ü–∏–µ–Ω—Ç–∫–∞ 42 –ª–µ—Ç, –∫–æ—Ç–æ—Ä—É—é –∫–æ–ª–ª–µ–≥–∏ —É–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç –ª–µ—á–∞—Ç "
        f"–ø–æ –ø–æ–≤–æ–¥—É {topic}, –∏ —è –≤–∏–∂—É, —á—Ç–æ —Å—Ö–µ–º–∞ —è–≤–Ω–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ. "
        f"–ù–æ —è –Ω–µ —É–≤–µ—Ä–µ–Ω, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –∏ –∫–∞–∫ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è."
    )


def _hook_expert_note(topic: str, drug: dict | None) -> str:
    if drug:
        return (
            f"–ò–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Å–ª—É—á–∞–π –∏–ª–ª—é—Å—Ç—Ä–∏—Ä—É–µ—Ç –≥–ª–∞–≤–Ω—É—é –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –¥–∏–ª–µ–º–º—É –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å {drug['name']}: "
            f"–∫–∞–∫ –æ—Ç–ª–∏—á–∏—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –æ—Ç –∏—Å—Ç–∏–Ω–Ω–æ–π –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏, "
            f"–∏ –∫–æ–≥–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –∞ –∫–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å —Ç–∞–∫—Ç–∏–∫—É. "
            f"–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞–∑–±–µ—Ä—ë–º {drug['name']} —Ç–∞–∫, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ç–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã."
        )
    return (
        f"–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ –≥–æ—Ä–∞–∑–¥–æ —á–∞—â–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è. "
        f"–°–µ–≥–æ–¥–Ω—è –º—ã —Å–∏—Å—Ç–µ–º–Ω–æ —Ä–∞–∑–±–µ—Ä—ë–º —Ç–µ–º—É ¬´{topic}¬ª ‚Äî –æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –¥–æ —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫."
    )


def _build_theory(topic: str, drug: dict | None, density: int) -> list[dict]:
    """Return list of dialogue exchanges for theory block."""
    exchanges = []
    if drug:
        exchanges.append({
            "resident": f"–ú–∏—Ö–∞–∏–ª –°–µ—Ä–≥–µ–µ–≤–∏—á, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º —Å –æ—Å–Ω–æ–≤. –ö–∞–∫ –≤–æ–æ–±—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç {drug['name']}?",
            "expert": (
                f"–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –ø–æ—à–∞–≥–æ–≤–æ. {drug['name']} ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∫–ª–∞—Å—Å–∞ {drug['class']}. "
                f"{drug['mechanism']} "
                f"–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º—ã –≤–æ–∑–¥–µ–π—Å—Ç–≤—É–µ–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, "
                f"–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–ø–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ¬ª."
            ),
        })
        exchanges.append({
            "resident": f"–¢–æ –µ—Å—Ç—å —ç—Ç–æ –∫–∞–∫... –Ω–∞—Å–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –æ—Ç–∫–∞—á–∏–≤–∞—Ç—å —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω –æ–±—Ä–∞—Ç–Ω–æ?",
            "expert": (
                f"–•–æ—Ä–æ—à–∞—è –∞–Ω–∞–ª–æ–≥–∏—è, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ—Ç–æ—á–Ω–∞—è. –ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Å–∫–∞–∑–∞—Ç—å: –ø–µ—Ä–µ–Ω–æ—Å—á–∏–∫ ‚Äî —ç—Ç–æ ¬´–Ω–∞—Å–æ—Å¬ª, "
                f"–∞ {drug['name']} –±–ª–æ–∫–∏—Ä—É–µ—Ç –µ–≥–æ. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω –¥–æ–ª—å—à–µ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å–∏–Ω–∞–ø—Ç–∏—á–µ—Å–∫–æ–π "
                f"—â–µ–ª–∏ –∏ —É—Å–ø–µ–≤–∞–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ—Å—Ç—Å–∏–Ω–∞–ø—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ—Ü–µ–ø—Ç–æ—Ä–∞–º–∏. "
                f"–í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å: —Å–∞–º –ø—Ä–µ–ø–∞—Ä–∞—Ç –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω ‚Äî –æ–Ω –ª–∏—à—å –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ —Ç–æ–≥–æ, "
                f"–∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤—ã–¥–µ–ª–∏–ª—Å—è."
            ),
        })
        exchanges.append({
            "resident": f"–ê –ø–æ—á–µ–º—É —Ç–æ–≥–¥–∞ —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞—Å—Ç—É–ø–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 2‚Äì4 –Ω–µ–¥–µ–ª–∏? –ù–∞—Å–æ—Å –∂–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å—Ä–∞–∑—É...",
            "expert": (
                f"–í–æ—Ç —ç—Ç–æ ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ë–ª–æ–∫–∞–¥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ë—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç "
                f"–≤ –ø–µ—Ä–≤—ã–µ —á–∞—Å—ã. –ù–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π: –¥–µ—Å–µ–Ω—Å–∏—Ç–∏–∑–∞—Ü–∏–∏ "
                f"–∞—É—Ç–æ—Ä–µ—Ü–µ–ø—Ç–æ—Ä–æ–≤, –Ω–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–∫, –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —ç–∫—Å–ø—Ä–µ—Å—Å–∏–∏ –≥–µ–Ω–æ–≤. "
                f"–ü–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞–¥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ–± —ç—Ç–æ–º —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ ‚Äî –∏–Ω–∞—á–µ –æ–Ω –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç –ª–µ—á–µ–Ω–∏–µ "
                f"—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é, —Ä–µ—à–∏–≤, —á—Ç–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç ¬´–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª."
            ),
        })
        if density >= 7:
            exchanges.append({
                "resident": "–ê –∫–∞–∫ –Ω–∞—Å—á—ë—Ç —Ñ–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏–∫–∏? –Ø —Å–ª—ã—à–∞–ª, —á—Ç–æ —ç—Ç–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã —Å–∏–ª—å–Ω–æ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è...",
                "expert": (
                    f"–°–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –≤–µ—Ä–Ω–æ, –∏ —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ. {drug['name']}: {drug.get('dosage', '–¥–æ–∑–∏—Ä–æ–≤–∫–∞ ‚Äî —É—Ç–æ—á–Ω–∏—Ç—å')}. "
                    f"–ü–µ—Ä–∏–æ–¥ –ø–æ–ª—É–≤—ã–≤–µ–¥–µ–Ω–∏—è, –º–µ—Ç–∞–±–æ–ª–∏–∑–º —á–µ—Ä–µ–∑ CYP-—Ñ–µ—Ä–º–µ–Ω—Ç—ã ‚Äî –≤—Å—ë —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ "
                    f"—á–∞—Å—Ç–æ—Ç—É –ø—Ä–∏—ë–º–∞, —Å–∏–Ω–¥—Ä–æ–º –æ—Ç–º–µ–Ω—ã –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏. "
                    f"–ó–∞–ø–æ–º–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ: —á–µ–º –¥–ª–∏–Ω–Ω–µ–µ T¬Ω ‚Äî —Ç–µ–º –º—è–≥—á–µ —Å–∏–Ω–¥—Ä–æ–º –æ—Ç–º–µ–Ω—ã, —Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ "
                    f"–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–≤–Ω–æ–≤–µ—Å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è."
                ),
            })
    else:
        exchanges.append({
            "resident": f"–ú–æ–∂–µ—Ç–µ –æ–±—ä—è—Å–Ω–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ {topic}?",
            "expert": (
                f"–ö–æ–Ω–µ—á–Ω–æ. –í –æ—Å–Ω–æ–≤–µ {topic} –ª–µ–∂–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö ‚Äî "
                f"–ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ —Å–µ—Ä–æ—Ç–æ–Ω–∏–Ω–æ–≤–æ–π, –Ω–æ—Ä–∞–¥—Ä–µ–Ω–µ—Ä–≥–∏—á–µ—Å–∫–æ–π –∏ –¥–æ—Ñ–∞–º–∏–Ω–æ–≤–æ–π. "
                f"–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –≤–æ–∑–¥–µ–π—Å—Ç–≤—É—é—Ç –Ω–∞ —ç—Ç–∏ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø—É—Ç—è–º–∏, "
                f"—á—Ç–æ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Ö –∫–ª–∏–Ω–∏—á–µ—Å–∫—É—é –Ω–∏—à—É."
            ),
        })
    return exchanges


def _build_clinical(topic: str, drug: dict | None, density: int) -> list[dict]:
    exchanges = []
    if drug:
        inds = drug.get("indications") or []
        ind_str = ", ".join(inds[:3]) if inds else topic

        exchanges.append({
            "resident": f"–•–æ—Ä–æ—à–æ, —Ç–µ–ø–µ—Ä—å –æ –ø—Ä–∞–∫—Ç–∏–∫–µ. –ö–æ–º—É –º—ã –Ω–∞–∑–Ω–∞—á–∞–µ–º {drug['name']}?",
            "expert": (
                f"–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è: {ind_str}. "
                f"–ù–∞—á–∏–Ω–∞–µ–º —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–æ–∑—ã ‚Äî {drug.get('dosage', '—É—Ç–æ—á–Ω–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—É—é –¥–æ–∑—É')}. "
                f"–ü—Ä–∞–≤–∏–ª–æ: start low, go slow. –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏."
            ),
        })
        exchanges.append({
            "resident": f"–ê –µ—Å–ª–∏ –Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ 4 –Ω–µ–¥–µ–ª–∏ ‚Äî —Å—Ä–∞–∑—É –º–µ–Ω—è–µ–º?",
            "expert": (
                f"–ù–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ! –ü–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º CANMAT, –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–π –∫—É—Ä—Å ‚Äî –º–∏–Ω–∏–º—É–º 6‚Äì8 –Ω–µ–¥–µ–ª—å "
                f"–≤ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–∑–µ. –ß–µ—Ä–µ–∑ 4 –Ω–µ–¥–µ–ª–∏ –æ—Ü–µ–Ω–∏–≤–∞–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç. "
                f"–ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –∫–∞–∫–∞—è-—Ç–æ –¥–∏–Ω–∞–º–∏–∫–∞ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏, –≤–æ–∑–º–æ–∂–Ω–æ, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ–∑—É. "
                f"–ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–≤—Å–µ–º ‚Äî –º–µ–Ω—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é."
            ),
        })
        if density >= 7:
            exchanges.append({
                "resident": f"–ü–∞—Ü–∏–µ–Ω—Ç, 68 –ª–µ—Ç, –¥–µ–ø—Ä–µ—Å—Å–∏—è, —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è –±–æ–ª—å –∏ –•–ë–ü 3 —Å—Ç–∞–¥–∏–∏. –ú–æ–∂–Ω–æ {drug['name']}?",
                "expert": (
                    f"–•–æ—Ä–æ—à–∏–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å. –ü—Ä–∏ –•–ë–ü –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ—á–µ—á–Ω—ã–π –∫–ª–∏—Ä–µ–Ω—Å –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞. "
                    f"{drug['name']} –≤ —Ü–µ–ª–æ–º –¥–æ–ø—É—Å—Ç–∏–º –ø—Ä–∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º —Å–Ω–∏–∂–µ–Ω–∏–∏ –°–ö–§, "
                    f"–Ω–æ –Ω—É–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Å –ø–æ–ª–æ–≤–∏–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –¥–æ–∑—ã –∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ç–∏—Ç—Ä–æ–≤–∞—Ç—å. "
                    f"–†–µ–≥—É–ª—è—Ä–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—á–µ–∫ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω."
                ),
            })
    else:
        exchanges.append({
            "resident": f"–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏ {topic}?",
            "expert": (
                f"–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑ –ø–æ –ú–ö–ë-10, "
                f"–≤—ã–±—Ä–∞—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç —Å —É—á—ë—Ç–æ–º –ø—Ä–æ—Ñ–∏–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞, –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–µ–∫–≤–∞—Ç–Ω—É—é –¥–æ–∑—É "
                f"–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç —á–µ—Ä–µ–∑ 2‚Äì4 –Ω–µ–¥–µ–ª–∏. "
                f"–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ ‚Äî —ç—Ç–æ –ª–∏–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–∏–∞–≥–Ω–æ–∑, –ª–∏–±–æ —Å—É–±—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∑–∞."
            ),
        })
    return exchanges


def _build_nr_block(topic: str, drug: dict | None) -> list[dict]:
    exchanges = []
    if drug:
        ses = drug.get("side_effects") or []
        inters = drug.get("interactions") or []
        main_se = ses[0] if ses else "–Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è"
        main_inter = inters[0] if inters else "–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏"

        exchanges.append({
            "resident": (
                f"–ó–≤–æ–Ω–æ–∫ –≤ –¥–≤–∞ —á–∞—Å–∞ –Ω–æ—á–∏. –ü–∞—Ü–∏–µ–Ω—Ç –Ω–∞ {drug['name']} —Ç—Ä–µ—Ç—å—é –Ω–µ–¥–µ–ª—é ‚Äî "
                f"–∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ {main_se.lower()}. –ß—Ç–æ –¥–µ–ª–∞—é?"
            ),
            "expert": (
                f"–í–æ-–ø–µ—Ä–≤—ã—Ö, –Ω–µ –ø–∞–Ω–∏–∫—É–π—Ç–µ –∏ –Ω–µ –æ—Ç–º–µ–Ω—è–π—Ç–µ —Å—Ä–∞–∑—É. "
                f"{main_se} ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã—Ö –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ {drug['name']}, "
                f"–∏ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –æ–Ω —Ç—Ä–∞–Ω–∑–∏—Ç–æ—Ä–Ω—ã–π. –û—Ü–µ–Ω–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ—Å—Ç—å (1‚Äì10), "
                f"—É—Ç–æ—á–Ω–∏—Ç–µ, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ. "
                f"–ï—Å–ª–∏ —É–º–µ—Ä–µ–Ω–Ω–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é. "
                f"–ï—Å–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ ‚Äî —Å–Ω–∏–∂–∞–µ–º –¥–æ–∑—É –∏–ª–∏ –º–µ–Ω—è–µ–º –ø—Ä–µ–ø–∞—Ä–∞—Ç."
            ),
        })
        exchanges.append({
            "resident": f"–ê –∫–∞–∫–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å–∞–º–æ–µ –æ–ø–∞—Å–Ω–æ–µ –¥–ª—è {drug['name']}?",
            "expert": (
                f"–õ–æ–≤—É—à–∫–∞-–ª–æ–≤—É—à–∫–∞: {main_inter}. "
                f"–≠—Ç–æ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–ª—å–∑—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å. "
                f"–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º ‚Äî "
                f"–æ—Å–æ–±–µ–Ω–Ω–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ —É –ø–æ–∂–∏–ª—ã—Ö —Å –ø–æ–ª–∏–ø—Ä–∞–≥–º–∞–∑–∏–µ–π."
            ),
        })
    else:
        exchanges.append({
            "resident": f"–ö–∞–∫–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã –ø—Ä–∏ {topic}?",
            "expert": (
                f"–ü—Ä–∏ {topic} –Ω—É–∂–Ω–æ –æ—Å–æ–±–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "
                f"–Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ (–≤–ª–∏—è—é—Ç –Ω–∞ –∫–æ–º–ø–ª–∞–µ–Ω—Ç–Ω–æ—Å—Ç—å), –Ω–∞–∏–±–æ–ª–µ–µ —Å–µ—Ä—å—ë–∑–Ω—ã–µ (—É–≥—Ä–æ–∂–∞—é—Ç –∂–∏–∑–Ω–∏), "
                f"–∏ –æ—Ç—Å—Ä–æ—á–µ–Ω–Ω—ã–µ (—Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª–∏‚Äì–º–µ—Å—è—Ü—ã). "
                f"–†–∞–∑–±–µ—Ä—ë–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ..."
            ),
        })
    return exchanges


def _build_errors(topic: str, drug: dict | None) -> list[dict]:
    errors = []
    if drug:
        errors.append({
            "resident": f"–Ø –≤–∏–¥–µ–ª —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –ø–∞—Ü–∏–µ–Ω—Ç—É –Ω–∞–∑–Ω–∞—á–∏–ª–∏ {drug['name']} –∏ —á–µ—Ä–µ–∑ 3 –¥–Ω—è –æ—Ç–º–µ–Ω–∏–ª–∏ ‚Äî ¬´–Ω–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞¬ª...",
            "expert": (
                f"–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ß–µ—Ä–µ–∑ 3 –¥–Ω—è –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –∞–Ω—Ç–∏–¥–µ–ø—Ä–µ—Å—Å–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Äî "
                f"–Ω–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –Ω–µ–¥–µ–ª—å. "
                f"–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: —á–µ—Ä–µ–∑ 3 –¥–Ω—è –æ—Ü–µ–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –∏ –Ω–µ—Ç –ª–∏ –æ–ø–∞—Å–Ω—ã—Ö –ù–†. "
                f"–ó–∞–ø–æ–º–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ: –º–∏–Ω–∏–º—É–º 2 –Ω–µ–¥–µ–ª–∏ –¥–æ –ø–µ—Ä–≤–æ–π –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞, 6‚Äì8 –Ω–µ–¥–µ–ª—å ‚Äî –¥–æ —Ä–µ—à–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ."
            ),
        })
        errors.append({
            "resident": f"–ï—â—ë –≤–∏–¥–µ–ª: –ø–∞—Ü–∏–µ–Ω—Ç —Å–∞–º –æ—Ç–º–µ–Ω–∏–ª {drug['name']} –∑–∞ –æ–¥–Ω—É –Ω–æ—á—å. –≠—Ç–æ –æ–ø–∞—Å–Ω–æ?",
            "expert": (
                f"–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞. –ü—Ä–∏ {drug['name']} —Ä–µ–∑–∫–∞—è –æ—Ç–º–µ–Ω–∞ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å "
                f"—Å–∏–Ω–¥—Ä–æ–º –æ—Ç–º–µ–Ω—ã —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º–∏ —Å–∏–º–ø—Ç–æ–º–∞–º–∏ FINISH: "
                f"flu-like, insomnia, nausea, imbalance, sensory disturbances, hyperarousal. "
                f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –≤—Å–µ–≥–¥–∞ —Å–Ω–∏–∂–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (10‚Äì25% –¥–æ–∑—ã –≤ –º–µ—Å—è—Ü). "
                f"–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–π—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏."
            ),
        })
        errors.append({
            "resident": "–ê –µ—Å–ª–∏ –¥–≤–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Äî –±—ã—Å—Ç—Ä–µ–µ –Ω–µ –±—É–¥–µ—Ç?",
            "expert": (
                "–ü–æ–ª–∏—Ç–µ—Ä–∞–ø–∏—è ‚Äî —ç—Ç–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π, –∞ –Ω–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞. "
                "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ø–æ–∫–∞–∑–∞–Ω–∏–π ‚Üí –±–æ–ª—å—à–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π, –±–æ–ª—å—à–µ –ù–†, —Å–ª–æ–∂–Ω–µ–µ –ø–æ–Ω—è—Ç—å, "
                "—á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü—Ä–∞–≤–∏–ª–æ: –º–æ–Ω–æ—Ç–µ—Ä–∞–ø–∏—è –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ–π –¥–æ–∑—ã ‚Äî "
                "–ø–æ—Ç–æ–º —Ä–µ—à–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ –∏–ª–∏ –∞—É–≥–º–µ–Ω—Ç–∞—Ü–∏–∏."
            ),
        })
    else:
        errors.append({
            "resident": f"–ö–∞–∫–∞—è —Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ {topic}?",
            "expert": (
                f"–°—É–±—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∑–∞. –í—Ä–∞—á –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–æ–∑—É –∏ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç, "
                f"–±–æ—è—Å—å –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤. –ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –í—ã–≤–æ–¥: ¬´–ø—Ä–µ–ø–∞—Ä–∞—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª. "
                f"–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ ‚Äî –¥–æ–∑–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–∞–ª–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è."
            ),
        })
    return errors


def _build_pearls(topic: str, drug: dict | None) -> list[str]:
    pearls = []
    tip_relevant = [t for t in TIPS if drug and drug["name"].lower() in t.lower()]
    if tip_relevant:
        pearls.append(tip_relevant[0].replace("üí° ", ""))
    if drug:
        drug_class = drug.get("class", "")
        if drug_class == "SSRI":
            pearls.append(
                "–ü—Ä–∏ SSRI-–∏–Ω–¥—É—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–µ—Å—Å–æ–Ω–Ω–∏—Ü–µ ‚Äî –Ω–µ –æ—Ç–º–µ–Ω—è—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç. –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–∏—ë–º –Ω–∞ —É—Ç—Ä–æ, "
                "–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å –º–µ–ª–∞—Ç–æ–Ω–∏–Ω. –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 2‚Äì4 –Ω–µ–¥–µ–ª–∏ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª—Å—è ‚Äî "
                "—Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–º–µ–Ω—É –Ω–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç —Å –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º."
            )
        elif drug_class == "–ê—Ç–∏–ø–∏—á–Ω—ã–µ –∞–Ω—Ç–∏–ø—Å–∏—Ö–æ—Ç–∏–∫–∏":
            pearls.append(
                "–ú–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏ –∞—Ç–∏–ø–∏—á–Ω—ã—Ö –∞–Ω—Ç–∏–ø—Å–∏—Ö–æ—Ç–∏–∫–∞—Ö ‚Äî –Ω–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π. "
                "–ò—Å—Ö–æ–¥–Ω–æ: –≤–µ—Å, –û–¢, –≥–ª—é–∫–æ–∑–∞, –ª–∏–ø–∏–¥—ã. –ß–µ—Ä–µ–∑ 3 –º–µ—Å ‚Äî –ø–æ–≤—Ç–æ—Ä. –ó–∞—Ç–µ–º –µ–∂–µ–≥–æ–¥–Ω–æ. "
                "–†–∞–Ω–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–±–æ–ª–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–Ω–¥—Ä–æ–º–∞ ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏."
            )
    if not pearls:
        pearls.append(random.choice(TIPS).replace("üí° ", ""))
    return pearls[:3]


def _build_key_points(topic: str, drug: dict | None) -> list[str]:
    points = []
    if drug:
        points.append(f"{drug['name']} ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∫–ª–∞—Å—Å–∞ {drug.get('class', '?')}: {(drug.get('mechanism') or '‚Äî')[:80]}")
        inds = drug.get("indications") or []
        if inds:
            points.append(f"–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è: {', '.join(inds[:3])}")
        points.append(f"–î–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ: {drug.get('dosage', '—É—Ç–æ—á–Ω–∏—Ç—å')}")
        ses = drug.get("side_effects") or []
        if ses:
            points.append(f"–ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –ù–†: {', '.join(ses[:3])}")
        points.append(f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞: 6‚Äì8 –Ω–µ–¥–µ–ª—å –≤ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–∑–µ")
    else:
        points = [
            f"–¢–µ–º–∞ {topic} ‚Äî –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–∞—è –æ–±–ª–∞—Å—Ç—å –ø—Å–∏—Ö–æ—Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏–∏",
            "–í—ã–±–æ—Ä –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –≤—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞",
            "–ê–¥–µ–∫–≤–∞—Ç–Ω–∞—è –¥–æ–∑–∞ + –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",
            "–ü–æ–ª–∏—Ç–µ—Ä–∞–ø–∏—è ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Ä–µ—Ñ—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤, –Ω–µ –ø–µ—Ä–≤–∞—è –ª–∏–Ω–∏—è",
            "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ù–† –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –≤–µ–¥–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞",
        ]
    return points[:5]


# ‚îÄ‚îÄ‚îÄ Telegram preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _build_telegram_preview(ep: dict) -> str:
    d = ep["drug"]
    name = d["name"] if d else ep["topic"]
    lines = [
        f"üéôÔ∏è *–≠–ø–∏–∑–æ–¥: {ep['topic'].upper()}*",
        f"–ü–æ–¥–∫–∞—Å—Ç ¬´–ü—Å–∏—Ö–æ—Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏—è: –æ—Ç —Ç–µ–æ—Ä–∏–∏ –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ¬ª",
        f"–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂: {ep['duration']}  |  {ep['date']}",
        "",
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        "*–ë–õ–û–ö 1 ‚Äî –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∫—Ä—é—á–æ–∫*",
        "",
        f"*–û–†–î–ò–ù–ê–¢–û–†:* {ep['hook_case']}",
        "",
        f"*–≠–ö–°–ü–ï–†–¢:* {ep['hook_expert_note']}",
        "",
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        "*–ë–õ–û–ö 2 ‚Äî –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç*",
        "",
    ]
    for ex in ep["theory"][:2]:
        lines.append(f"*–û–†–î–ò–ù–ê–¢–û–†:* {ex['resident']}")
        lines.append("")
        lines.append(f"*–≠–ö–°–ü–ï–†–¢:* {ex['expert']}")
        lines.append("")

    lines += [
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        "*–ë–õ–û–ö 5 ‚Äî –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏*",
        "",
    ]
    for err in ep["errors"][:2]:
        lines.append(f"*–û–†–î–ò–ù–ê–¢–û–†:* {err['resident']}")
        lines.append("")
        lines.append(f"*–≠–ö–°–ü–ï–†–¢:* {err['expert']}")
        lines.append("")

    lines += [
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        "*–ë–õ–û–ö 7 ‚Äî –†–µ–∑—é–º–µ: 5 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–∑–∏—Å–æ–≤*",
        "",
    ]
    for i, pt in enumerate(ep["key_points"], 1):
        lines.append(f"{i}. {pt}")

    return "\n".join(lines)


# ‚îÄ‚îÄ‚îÄ Telegram announcement ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _build_telegram_announce(ep: dict, topic: str) -> str:
    d = ep["drug"]
    drug_name = d["name"] if d else topic
    ind = (d.get("indications") or [topic])[0] if d else topic
    pearl = ep["pearls"][0] if ep["pearls"] else "–í—ã–±–æ—Ä –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –≤—Å–µ–≥–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ—Ñ–∏–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞."

    lines = [
        f"üéôÔ∏è *–ù–û–í–´–ô –≠–ü–ò–ó–û–î ‚Äî {topic.upper()}*",
        "",
        f"_{ep['hook_case'][:150]}..._" if len(ep.get("hook_case", "")) > 150 else f"_{ep.get('hook_case', '')}_ ",
        "",
        "–í —ç—Ç–æ–º –≤—ã–ø—É—Å–∫–µ —Ä–∞–∑–±–∏—Ä–∞–µ–º:",
        f"‚Ä¢ –ú–µ—Ö–∞–Ω–∏–∑–º –¥–µ–π—Å—Ç–≤–∏—è –∏ —Ñ–∞—Ä–º–∞–∫–æ–∫–∏–Ω–µ—Ç–∏–∫—É {drug_name}",
        f"‚Ä¢ –ö–æ–º—É –Ω–∞–∑–Ω–∞—á–∞—Ç—å (–∏ –∫–æ–º—É —Ç–æ—á–Ω–æ –Ω–µ–ª—å–∑—è)",
        f"‚Ä¢ –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ ‚Äî —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å–ª—É—á–∞—è–º–∏",
        f"‚Ä¢ –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –∂–µ–º—á—É–∂–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏",
        "",
        "üí° *–ñ–µ–º—á—É–∂–∏–Ω–∞ —ç–ø–∏–∑–æ–¥–∞:*",
        pearl[:200] + "‚Ä¶" if len(pearl) > 200 else pearl,
        "",
        "‚ùì *–í–æ–ø—Ä–æ—Å —Å–ª—É—à–∞—Ç–µ–ª—è–º:*",
        f"–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ –æ–±—ä—è—Å–Ω—è–µ—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç—É, –ø–æ—á–µ–º—É —ç—Ñ—Ñ–µ–∫—Ç {drug_name} –Ω–∞—Å—Ç—É–ø–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 2‚Äì4 –Ω–µ–¥–µ–ª–∏?",
        "",
        "üîó –°–ª—É—à–∞—Ç—å: [—Å—Å—ã–ª–∫–∞]",
        "",
        f"#–ø—Å–∏—Ö–æ—Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏—è #–ø—Å–∏—Ö–∏–∞—Ç—Ä–∏—è #{drug_name.lower().replace(' ', '_')} #–æ–±—É—á–µ–Ω–∏–µ #–æ—Ä–¥–∏–Ω–∞—Ç—É—Ä–∞",
    ]
    text = "\n".join(lines)
    if len(text) > 2000:
        text = text[:1997] + "‚Ä¶"
    return text


# ‚îÄ‚îÄ‚îÄ DOCX builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def _build_docx(ep: dict, topic: str, duration: str) -> io.BytesIO:
    from docx import Document
    from docx.shared import Pt, RGBColor
    from docx.enum.text import WD_ALIGN_PARAGRAPH

    doc = Document()
    d = ep["drug"]
    drug_name = d["name"] if d else topic

    # ‚îÄ‚îÄ Block 0: Meta ‚îÄ‚îÄ
    title = doc.add_heading(f"–≠–ü–ò–ó–û–î: {topic.upper()}", 0)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    sub = doc.add_paragraph("–ü–æ–¥–∫–∞—Å—Ç ¬´–ü—Å–∏—Ö–æ—Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏—è: –æ—Ç —Ç–µ–æ—Ä–∏–∏ –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ¬ª")
    sub.alignment = WD_ALIGN_PARAGRAPH.CENTER

    for label, value in [
        ("–•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂", ep["duration"]),
        ("–î–∞—Ç–∞", ep["date"]),
        ("–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞", drug_name + ", –ø—Å–∏—Ö–æ—Ñ–∞—Ä–º–∞–∫–æ–ª–æ–≥–∏—è, " + (d.get("class") or topic if d else topic)),
    ]:
        p = doc.add_paragraph()
        p.add_run(f"{label}: ").bold = True
        p.add_run(value)

    doc.add_page_break()

    # Helper to add a dialogue exchange
    line_counter = [1]

    def add_exchange(speaker: str, text: str):
        p = doc.add_paragraph()
        num = f"[{line_counter[0]:03d}] "
        run_num = p.add_run(num)
        run_num.font.color.rgb = RGBColor(0x88, 0x88, 0x88)
        run_speaker = p.add_run(f"{speaker}: ")
        run_speaker.bold = True
        p.add_run(text)
        line_counter[0] += 1

    # ‚îÄ‚îÄ Block 1: Hook ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 1. –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –∫—Ä—é—á–æ–∫ (~2‚Äì3 –º–∏–Ω)", 1)
    add_exchange("–û–†–î–ò–ù–ê–¢–û–†", ep["hook_case"])
    add_exchange("–≠–ö–°–ü–ï–†–¢", ep["hook_expert_note"])
    doc.add_paragraph()

    # ‚îÄ‚îÄ Block 2: Theory ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 2. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç (~5‚Äì7 –º–∏–Ω)", 1)
    for ex in ep["theory"]:
        add_exchange("–û–†–î–ò–ù–ê–¢–û–†", ex["resident"])
        add_exchange("–≠–ö–°–ü–ï–†–¢", ex["expert"])
        doc.add_paragraph()

    # ‚îÄ‚îÄ Block 3: Clinical ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 3. –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è (~8‚Äì12 –º–∏–Ω)", 1)
    for ex in ep["clinical"]:
        add_exchange("–û–†–î–ò–ù–ê–¢–û–†", ex["resident"])
        add_exchange("–≠–ö–°–ü–ï–†–¢", ex["expert"])
        doc.add_paragraph()

    # ‚îÄ‚îÄ Block 4: NR ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 4. –ù–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (~5‚Äì7 –º–∏–Ω)", 1)
    for ex in ep["nr_block"]:
        add_exchange("–û–†–î–ò–ù–ê–¢–û–†", ex["resident"])
        add_exchange("–≠–ö–°–ü–ï–†–¢", ex["expert"])
        doc.add_paragraph()

    # ‚îÄ‚îÄ Block 5: Errors ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 5. –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ (~3‚Äì5 –º–∏–Ω)", 1)
    for ex in ep["errors"]:
        add_exchange("–û–†–î–ò–ù–ê–¢–û–†", ex["resident"])
        add_exchange("–≠–ö–°–ü–ï–†–¢", ex["expert"])
        doc.add_paragraph()

    # ‚îÄ‚îÄ Block 6: Pearls ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 6. –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –∂–µ–º—á—É–∂–∏–Ω—ã (~2‚Äì3 –º–∏–Ω)", 1)
    for pearl in ep["pearls"]:
        p = doc.add_paragraph()
        p.add_run("üí° ").bold = True
        p.add_run(pearl)
    doc.add_paragraph()

    # ‚îÄ‚îÄ Block 7: Summary ‚îÄ‚îÄ
    doc.add_heading("–ë–ª–æ–∫ 7. –†–µ–∑—é–º–µ —ç–ø–∏–∑–æ–¥–∞ (~2‚Äì3 –º–∏–Ω)", 1)
    add_exchange(
        "–û–†–î–ò–ù–ê–¢–û–†",
        f"–ò—Ç–∞–∫, –µ—Å–ª–∏ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π ‚Äî {drug_name} —ç—Ç–æ... [–ø—ã—Ç–∞–µ—Ç—Å—è —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å]"
    )
    add_exchange(
        "–≠–ö–°–ü–ï–†–¢",
        f"–í—ã –ø–æ—á—Ç–∏ —Ç–æ—á–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–ª–∏. –í–æ—Ç –ø—è—Ç—å —Ç–µ–∑–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É–Ω–µ—Å—Ç–∏ –∏–∑ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ —ç–ø–∏–∑–æ–¥–∞:"
    )
    doc.add_paragraph()
    for i, pt in enumerate(ep["key_points"], 1):
        doc.add_paragraph(f"{i}. {pt}", style="List Number")
    doc.add_paragraph()

    # ‚îÄ‚îÄ Telegram announce ‚îÄ‚îÄ
    doc.add_page_break()
    doc.add_heading("Telegram-–∞–Ω–æ–Ω—Å", 1)
    doc.add_paragraph(_build_telegram_announce(ep, topic))

    buf = io.BytesIO()
    doc.save(buf)
    buf.seek(0)
    return buf
